- name: Aplicar controles
  hosts: web
  become: yes
  tasks:
    - name: Asegurarse de que los servicios innecesarios no estén activos
      ansible.builtin.systemd:
        name: "{{ item }}"
        enable: no
        state: stopped
      loop:
        - autofs
        - avahi-daemon
        - dhcpd
        - named
        - dnsmasq
        - smb
        - vsftpd
        - dovecot
        - nfs-server
        - ypserv
        - cups
        - rpcbind
        - rsyncd
        - snmpd
        - telnet.socket
        - tftp.socket
        - squid
        - httpd
        - nginx
        - xinetd
        - xorg
      ignore_errors: yes
      
    - name: Verificar y eliminar paquetes de servicios no deseados si es necesario
      ansible.builtin.package:
        name: "{{ item }}"
        state: absent
      loop:
        - autofs
        - avahi
        - dhcp-server
        - bind
        - dnsmasq
        - samba
        - vsftpd
        - dovecot
        - nfs-utils
        - ypserv
        - cups
        - rpcbind
        - rsync
        - net-snmp
        - telnet-server
        - tftp-server
        - squid
        - httpd
        - nginx
        - xinetd
        - xorg-x11-server-Xorg

    - name: Deshabilitar módulo de cramfs
      ansible.builtin.shell: "modprobe -r cramfs"
      
    - name: Asegurar que cramfs esté deshabilitado permanentemente
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/CIS.conf
        line: "install cramfs /bin/true"
        create: yes

    - name: Habilitar LogLevel INFO
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^LogLevel'
        line: 'LogLevel INFO'

    - name: Reinicio servicio SSH  
      ansible.builtin.service:
        name: sshd
        state: restarted

     - name: Configurar política de auditoría para modificaciones de privilegios sudo
        ansible.builtin.lineinfile:
          path: /etc/audit/rules.d/audit.rules
          line: '-w /etc/sudoers -p wa -k actions'
          create: yes
